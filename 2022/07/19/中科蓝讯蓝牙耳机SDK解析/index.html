<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>中科蓝讯蓝牙耳机SDK解析 | JS</title><meta name="keywords" content="蓝讯教程,SDK"><meta name="author" content="JSmcu"><meta name="copyright" content="JSmcu"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SDK结构1.1	SDK目录结构└─app     ├─platform            │  ├─bsp       				&#x2F;&#x2F;底层外设相关     │  ├─functions   			&#x2F;&#x2F;功能相关     │  ├─gui        				&#x2F;&#x2F;显示功能     │  ├─header     │  └─libs">
<meta property="og:type" content="article">
<meta property="og:title" content="中科蓝讯蓝牙耳机SDK解析">
<meta property="og:url" content="https://nameiscn.github.io/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E8%AE%AF%E8%93%9D%E7%89%99%E8%80%B3%E6%9C%BASDK%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="JS">
<meta property="og:description" content="SDK结构1.1	SDK目录结构└─app     ├─platform            │  ├─bsp       				&#x2F;&#x2F;底层外设相关     │  ├─functions   			&#x2F;&#x2F;功能相关     │  ├─gui        				&#x2F;&#x2F;显示功能     │  ├─header     │  └─libs">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
<meta property="article:published_time" content="2022-07-18T16:12:18.432Z">
<meta property="article:modified_time" content="2022-07-18T16:12:01.695Z">
<meta property="article:author" content="JSmcu">
<meta property="article:tag" content="蓝讯教程">
<meta property="article:tag" content="SDK">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"><link rel="shortcut icon" href="/myblog/img/favicon.png"><link rel="canonical" href="https://nameiscn.github.io/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E8%AE%AF%E8%93%9D%E7%89%99%E8%80%B3%E6%9C%BASDK%E8%A7%A3%E6%9E%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/myblog/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/myblog/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '中科蓝讯蓝牙耳机SDK解析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-07-19 00:12:01'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/myblog/atom.xml" title="JS" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/myblog/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/myblog/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/myblog/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><hr/></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/myblog/">JS</a></span><div id="menus"><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">中科蓝讯蓝牙耳机SDK解析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-07-18T16:12:18.432Z" title="发表于 2022-07-19 00:12:18">2022-07-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-07-18T16:12:01.695Z" title="更新于 2022-07-19 00:12:01">2022-07-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/myblog/categories/%E8%93%9D%E8%AE%AF%E5%BC%80%E5%8F%91/">蓝讯开发</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="中科蓝讯蓝牙耳机SDK解析"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="SDK结构"><a href="#SDK结构" class="headerlink" title="SDK结构"></a>SDK结构</h2><h4 id="1-1SDK目录结构"><a href="#1-1SDK目录结构" class="headerlink" title="1.1	SDK目录结构"></a>1.1	SDK目录结构</h4><pre class="language-none"><code class="language-none">└─app
    ├─platform       
    │  ├─bsp       				&#x2F;&#x2F;底层外设相关
    │  ├─functions   			&#x2F;&#x2F;功能相关
    │  ├─gui        				&#x2F;&#x2F;显示功能
    │  ├─header
    │  └─libs
    └─projects						&#x2F;&#x2F;调用API
        └─earphone
            ├─display   			&#x2F;&#x2F;显示
            ├─message  			&#x2F;&#x2F;消息处理
            ├─Output   			&#x2F;&#x2F;文件输出
            │  └─bin   			&#x2F;&#x2F;音乐文件，配置
            │      ├─res
            │      │  ├─en
            │      │  ├─eq
            │      │  └─zh
            │      └─Settings
            │          └─Resources
            │              ├─S6
            │              │  ├─en
            │              │  └─zh
            │              └─TWS
            │                  ├─en
            │                  └─zh
            ├─plugin				&#x2F;&#x2F;插件
            └─port					&#x2F;&#x2F;移植</code></pre>


<h5 id="1-1-1bsp目录"><a href="#1-1-1bsp目录" class="headerlink" title="1.1.1	bsp目录"></a>1.1.1	bsp目录</h5><p>该目录下，包含一些和底层硬件相关的数据，函数初始化</p>
<p><img src="https://img-blog.csdnimg.cn/20200301172832299.png" alt="在这里插入图片描述"></p>
<h5 id="1-1-2functions目录"><a href="#1-1-2functions目录" class="headerlink" title="1.1.2	functions目录"></a>1.1.2	functions目录</h5><p>主要包括蓝牙功能的实现，大部分的函数以库函数的形式提供<br> <img src="https://img-blog.csdnimg.cn/20200301172849850.png" alt="在这里插入图片描述"></p>
<h5 id="1-1-3Message目录"><a href="#1-1-3Message目录" class="headerlink" title="1.1.3	Message目录"></a>1.1.3	Message目录</h5><p>主要包括按键消息处理，是蓝牙方案经常需要改动的目录<br> <img src="https://img-blog.csdnimg.cn/20200301172856481.png" alt="在这里插入图片描述"></p>
<h5 id="1-1-4Plugin目录"><a href="#1-1-4Plugin目录" class="headerlink" title="1.1.4	Plugin目录"></a>1.1.4	Plugin目录</h5><p>音乐文件的调用，基本不会去修改这里<br> <img src="https://img-blog.csdnimg.cn/20200301172909689.png" alt="在这里插入图片描述"></p>
<h5 id="1-1-5Port目录"><a href="#1-1-5Port目录" class="headerlink" title="1.1.5	Port目录"></a>1.1.5	Port目录</h5><p>主要包括硬件外设的调用，mani函数</p>
<p> <img src="https://img-blog.csdnimg.cn/20200301172905332.png" alt="在这里插入图片描述"></p>
<h3 id="2代码运行流程"><a href="#2代码运行流程" class="headerlink" title="2	代码运行流程"></a>2	代码运行流程</h3><h4 id="2-1初始化"><a href="#2-1初始化" class="headerlink" title="2.1	初始化"></a>2.1	初始化</h4><pre class="language-none"><code class="language-none">&#x2F;&#x2F;正常启动Main函数
int main(void)
&#123;
    printf(&quot;Hello AB533X!\n&quot;);
    bsp_sys_init();

    func_run();
    return 0;
&#125;
</code></pre>
<p>bsp_sys_init();函数主要包括各种功能的初始化，<strong>获取download工具的配置。</strong><br>func_run();主要是处理蓝牙消息和硬件的消息。</p>
<h4 id="2-2各模式循环"><a href="#2-2各模式循环" class="headerlink" title="2.2	各模式循环"></a>2.2	各模式循环</h4><p>初始化之后，进入一个FUN函数，蓝牙耳机的FUN函数基本上都在跑func_bt</p>
<pre class="language-none"><code class="language-none">void func_run(void)
&#123;
    printf(&quot;%s\n&quot;, __func__);
    &#x2F;&#x2F;func_cb.sta &#x3D; FUNC_AUX;
    while (1) &#123;
        func_clear();
        switch (func_cb.sta) &#123;
#if FUNC_BT_EN
        case FUNC_BT:
            func_bt();
            break;
#endif

#if FUNC_BTHID_EN
        case FUNC_BTHID:
            func_bthid();

            break;
#endif &#x2F;&#x2F; FUNC_BTHID_EN

#if FUNC_AUX_EN
        case FUNC_AUX:
            func_aux();
            break;
#endif &#x2F;&#x2F; FUNC_AUX_EN

        case FUNC_PWROFF:
            func_pwroff(sys_cb.pwrdwn_tone_en);
            break;

        case FUNC_BT_CBT:
            func_bt_cbt();
            break;

        default:
            func_exit();
            break;
        &#125;
    &#125;
&#125;
</code></pre>
<h4 id="2-3蓝牙模式"><a href="#2-3蓝牙模式" class="headerlink" title="2.3	蓝牙模式"></a>2.3	蓝牙模式</h4><pre class="language-none"><code class="language-none">AT(.text.func.bt)
void func_bt(void)
&#123;
    printf(&quot;func_bt\n&quot;);
    func_bt_enter();
    while (func_cb.sta &#x3D;&#x3D; FUNC_BT) &#123;
        func_bt_process();
        func_bt_message(msg_dequeue());
    &#125;
    func_bt_exit();
&#125;
</code></pre>
<p>在程序跑到func_bt();的时候，SDK留给开发者处理的只有消息处理和电量检测，来电检测等，蓝牙耳机接收音频信号，解码那些都是屏蔽起来的。<br>printf(“%s\n”, <strong>func</strong>);</p>
<h5 id="2-3-1进入蓝牙模式"><a href="#2-3-1进入蓝牙模式" class="headerlink" title="2.3.1	进入蓝牙模式"></a>2.3.1	进入蓝牙模式</h5><p>func_bt_enter();<br>主要执行蓝牙初始化，播报提示音</p>
<h5 id="2-3-2蓝牙模式大循环"><a href="#2-3-2蓝牙模式大循环" class="headerlink" title="2.3.2	蓝牙模式大循环"></a>2.3.2	蓝牙模式大循环</h5><p>func_bt_process();<br>包括响铃，通话，蓝牙音乐<br>sfunc_bt_ring();<br>sfunc_bt_call();</p>
<p>func_bt_message(msg_dequeue());<br>消息处理</p>
<h5 id="2-3-3补充"><a href="#2-3-3补充" class="headerlink" title="2.3.3	补充"></a>2.3.3	补充</h5><p>C语言的特殊宏<br>LINE 表示正在编译的文件的行号<br>FILE 表示正在编译的文件的名字<br>DATE_ 表示编译时刻的日期字符串，例如： “25 Dec 2007”<br>TIME 表示编译时刻的时间字符串，例如： “12:30:55”</p>
<pre class="language-none"><code class="language-none">#include &lt;stdio.h&gt;
int main(void)
&#123;

        printf(&quot;%s\r\n&quot;,__FILE__);
        printf(&quot;%d\r\n&quot;,__LINE__);
        printf(&quot;%s\r\n&quot;,__DATE__);
        printf(&quot;%s\r\n&quot;,__TIME__);
        return 0;

&#125;

</code></pre>
<p>打印结果</p>
<pre class="language-none"><code class="language-none">speci_define.c
6
Jul  6 2019
00:46:39</code></pre>


<h4 id="2-4消息"><a href="#2-4消息" class="headerlink" title="2.4	消息"></a>2.4	消息</h4><p>经常需要改动的部分</p>
<h5 id="2-4-1消息处理："><a href="#2-4-1消息处理：" class="headerlink" title="2.4.1	消息处理："></a>2.4.1	消息处理：</h5><p>二次开发中修改最多的部分就是消息处理这一块，按键消息处理的修改最多。按键消息有长按，短按，双击，三击，四击，五击等等<br>Func函数的为例</p>
<pre class="language-none"><code class="language-none">AT(.text.func.msg)
void func_message(u16 msg)
&#123;
    switch (msg) &#123;
        case KL_NEXT_VOL_UP:&#x2F;&#x2F;如果长按NEXT_VOL_UP这个按键
            if (sfunc_bt_call_flag) &#123;
		……
            break;
	&#125;
	……
&#125;
</code></pre>
<h5 id="2-4-2消息来源："><a href="#2-4-2消息来源：" class="headerlink" title="2.4.2	消息来源："></a>2.4.2	消息来源：</h5><p>以按键为例</p>
<pre class="language-none"><code class="language-none">void msg_enqueue(u16 msg);&#x2F;&#x2F;消息队列</code></pre>
<p>在程序中执行按键扫描函数：</p>
<pre class="language-none"><code class="language-none">
u8 bsp_key_scan(void)
&#123;
    u8 key_val &#x3D; NO_KEY;
    u16 key &#x3D; NO_KEY;

    pwrkey_2_hw_pwroff_detect();

    if (!get_adc_val()) &#123;
        return NO_KEY;
    &#125;

#if USER_ADKEY
    key_val &#x3D; get_adkey(adc_cb.key_val, xcfg_cb.user_adkey_en);
#endif &#x2F;&#x2F; USER_ADKEY

#if USER_ADKEY2
    if (key_val &#x3D;&#x3D; NO_KEY) &#123;
        key_val &#x3D; get_adkey2();
    &#125;
#endif &#x2F;&#x2F; USER_ADKEY2

#if USER_IOKEY
    if (key_val &#x3D;&#x3D; NO_KEY) &#123;
        key_val &#x3D; get_iokey();
    &#125;
#endif &#x2F;&#x2F; USER_IOKEY

#if USER_PWRKEY
    if (key_val &#x3D;&#x3D; NO_KEY) &#123;
        key_val &#x3D; get_pwrkey();
    &#125;
#endif &#x2F;&#x2F; USER_PWRKEY

#if VBAT_DETECT_EN
    sys_cb.vbat &#x3D; get_vbat_val();
#endif &#x2F;&#x2F; VBAT_DETECT_EN

#if (IRRX_SW_EN || IRRX_HW_EN)
    if (key_val &#x3D;&#x3D; NO_KEY) &#123;
        key_val &#x3D; get_irkey();
    &#125;
#endif &#x2F;&#x2F; (IRRX_SW_EN || IRRX_HW_EN)

#if USER_ADKEY_MUX_SDCLK
    &#x2F;&#x2F;需要放到最后处理,当没进行adc convert需要返回
    if (key_val &#x3D;&#x3D; NO_KEY) &#123;
        if (!adc_cb.sdclk_valid) &#123;
            return NO_KEY;
        &#125;
        key_val &#x3D; get_adkey(adc_cb.sdclk_val, xcfg_cb.user_adkey_mux_sdclk_en);
    &#125;
#endif &#x2F;&#x2F; USER_ADKEY_MUX_SDCLK

    key &#x3D; bsp_key_process(key_val);&#x2F;&#x2F;得到具体按下哪个按键
    if (key !&#x3D; NO_KEY) &#123;
        &#x2F;&#x2F;printf(&quot;enqueue: %04x\n&quot;, key);
        if ((key &amp; KEY_TYPE_MASK) &#x3D;&#x3D; KEY_LONG_UP) &#123;
            msg_queue_detach(key | KEY_HOLD);       &#x2F;&#x2F;长按抬键，先清掉HOLD按键消息
        &#125;

#if KEY_MSG_REMAP_EN
        key_msg_remap(&amp;key);   &#x2F;&#x2F;按键重映射.
#endif
        msg_enqueue(key);&#x2F;&#x2F;把消息放到消息队列
    &#125;
    return key_val;
&#125;
</code></pre>
<h5 id="2-4-3按键消息的注意事项："><a href="#2-4-3按键消息的注意事项：" class="headerlink" title="2.4.3	按键消息的注意事项："></a>2.4.3	按键消息的注意事项：</h5><p>下面的宏都是按键消息：<br>以PLAY按键为例</p>
<pre class="language-none"><code class="language-none">
#define K_PLAY                  (KEY_PLAY | KEY_SHORT)		&#x2F;&#x2F;下降沿
#define KU_PLAY                 (KEY_PLAY | KEY_SHORT_UP)          &#x2F;&#x2F;上升沿
#define KL_PLAY                 (KEY_PLAY | KEY_LONG) 		&#x2F;&#x2F;长按
#define KLU_PLAY                (KEY_PLAY | KEY_LONG_UP) 	&#x2F;&#x2F;长按上升沿
#define KH_PLAY                 (KEY_PLAY | KEY_HOLD) 		&#x2F;&#x2F;长按2秒左右
#define KD_PLAY                 (KEY_PLAY | KEY_DOUBLE) 		&#x2F;&#x2F;双击
#define KTH_PLAY                (KEY_PLAY | KEY_THREE) 		&#x2F;&#x2F;三击
#define KFO_PLAY                (KEY_PLAY | KEY_FOUR) 		&#x2F;&#x2F;四击
#define KFI_PLAY                (KEY_PLAY | KEY_FIVE) 		&#x2F;&#x2F;五击
</code></pre>

<p>注意！每次按键都会触发下降沿。<br>以蓝牙模式为例：<br>程序先在func_bt_message函数做判断，如果在该函数没有找到一致的case，则会跑到公共的消息处理函数中 void func_message(u16 msg) 再做判断。</p>
<pre class="language-none"><code class="language-none">AT(.text.func.bt.msg)
void func_bt_message(u16 msg)
&#123;
    switch (msg) &#123;

    case KU_PLAY:
    case KU_PLAY_POWER:
    case KU_PLAY_MODE:
        bt_music_play_pause();
        f_bt.pp_2_unmute &#x3D; sys_cb.mute;
        break;

    case KU_PREV_VOL_DOWN:
    case KL_VOL_DOWN_PREV:
    case KU_PREV:
        bt_music_prev();
        sys_cb.key2unmute_cnt &#x3D; 15 * sys_cb.mute;
        break;
	……
    default:
        func_message(msg);
        break;</code></pre>


<h5 id="2-4-4应用：1S消息"><a href="#2-4-4应用：1S消息" class="headerlink" title="2.4.4	应用：1S消息"></a>2.4.4	应用：1S消息</h5><p>再定时器中，每隔一秒发送一个消息MSG_SYS_1S</p>
<pre class="language-none"><code class="language-none">msg_enqueue(MSG_SYS_1S);
    void usr_tmr5ms_isr(void)
&#123;
&#x2F;&#x2F;1s timer process
    if ((tmr5ms_cnt % 200) &#x3D;&#x3D; 0) &#123;
        msg_enqueue(MSG_SYS_1S);
        tmr5ms_cnt &#x3D; 0;
        sys_cb.lpwr_warning_cnt++;
    &#125;
&#125;</code></pre>

<p>再蓝牙消息或者公共消息做处理，常用的1秒消息处理有报告电量，连接蓝牙自动播放。</p>
<pre class="language-none"><code class="language-none">case MSG_SYS_1S:
      bt_send_msg(BT_MSG_HFP_REPORT_BAT);
      break;</code></pre>

<h5 id="2-4-5蓝牙消息函数："><a href="#2-4-5蓝牙消息函数：" class="headerlink" title="2.4.5	蓝牙消息函数："></a>2.4.5	蓝牙消息函数：</h5><p>三个状态的消息处理，蓝牙模式比较特殊，除了一个func_bt_message还有两个，响铃，通话。</p>
<p>响铃:void sfunc_bt_ring_message(u16 msg)<br>来电响铃的时候执行消息处理，主要包括接&#x2F;挂电话，电量报告和按键消息公共处理。</p>
<pre class="language-none"><code class="language-none">AT(.text.func.btring.msg)
void sfunc_bt_ring_message(u16 msg)
&#123;
    switch (msg) &#123;
    case KU_PLAY:
    case KU_HSF:                &#x2F;&#x2F;接听
    case KU_PLAY_POWER:
    case KU_PLAY_MODE:
        bsp_clr_mute_sta();
        bt_call_answer_incoming();
        break;

    case KD_PLAY:
    case KL_HSF:
    case KD_HSF:
        bsp_clr_mute_sta();
        bt_call_terminate();    &#x2F;&#x2F;挂断
        break;

    case MSG_SYS_1S:
        bt_send_msg(BT_MSG_HFP_REPORT_BAT);
        break;

    default:
        func_message(msg);
        break;
    &#125;
&#125;</code></pre>

<p>通话中:sfunc_bt_call_message();<br>通话过程的按键消息处理，主要包括音量调整，三方通话，电量报告</p>
<p>Music: void func_bt_message(u16 msg)<br>    蓝牙音乐模式的消息处理，上下曲切换，暂停播放，音量调整，报告电池电量等</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://nameiscn.github.io/myblog">JSmcu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://nameiscn.github.io/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E8%AE%AF%E8%93%9D%E7%89%99%E8%80%B3%E6%9C%BASDK%E8%A7%A3%E6%9E%90/">https://nameiscn.github.io/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E8%AE%AF%E8%93%9D%E7%89%99%E8%80%B3%E6%9C%BASDK%E8%A7%A3%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://nameiscn.github.io/myblog" target="_blank">JS</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/myblog/tags/%E8%93%9D%E8%AE%AF%E6%95%99%E7%A8%8B/">蓝讯教程</a><a class="post-meta__tags" href="/myblog/tags/SDK/">SDK</a></div><div class="post_share"><div class="social-share" data-image="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E6%B1%9B%E8%93%9D%E7%89%99%E8%80%B3%E6%9C%BAAB5356A_AB5376A%E8%BF%9B%E5%85%A5CBT%E6%A8%A1%E5%BC%8F/"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/myblog/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">中科蓝讯蓝牙耳机AB5356A_AB5376A进入CBT模式</div></div></a></div><div class="next-post pull-right"><a href="/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E8%AE%AFAB5325A%E9%9F%B3%E7%AE%B1%E5%9B%9E%E8%BF%9E%E6%85%A2%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="onerror=null;src='/myblog/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">中科蓝讯AB5325A音箱回连慢解决方法</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="this.onerror=null;this.src='/myblog/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">JSmcu</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/myblog/archives/"><div class="headline">文章</div><div class="length-num">11</div></a><a href="/myblog/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/myblog/categories/"><div class="headline">分类</div><div class="length-num">1</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SDK%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">SDK结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1SDK%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">1.0.1.</span> <span class="toc-text">1.1	SDK目录结构</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-1bsp%E7%9B%AE%E5%BD%95"><span class="toc-number">1.0.1.1.</span> <span class="toc-text">1.1.1	bsp目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-2functions%E7%9B%AE%E5%BD%95"><span class="toc-number">1.0.1.2.</span> <span class="toc-text">1.1.2	functions目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-3Message%E7%9B%AE%E5%BD%95"><span class="toc-number">1.0.1.3.</span> <span class="toc-text">1.1.3	Message目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-4Plugin%E7%9B%AE%E5%BD%95"><span class="toc-number">1.0.1.4.</span> <span class="toc-text">1.1.4	Plugin目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-1-5Port%E7%9B%AE%E5%BD%95"><span class="toc-number">1.0.1.5.</span> <span class="toc-text">1.1.5	Port目录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E4%BB%A3%E7%A0%81%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.1.</span> <span class="toc-text">2	代码运行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.1.1.</span> <span class="toc-text">2.1	初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2%E5%90%84%E6%A8%A1%E5%BC%8F%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.2	各模式循环</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3%E8%93%9D%E7%89%99%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.3.</span> <span class="toc-text">2.3	蓝牙模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-1%E8%BF%9B%E5%85%A5%E8%93%9D%E7%89%99%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">2.3.1	进入蓝牙模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-2%E8%93%9D%E7%89%99%E6%A8%A1%E5%BC%8F%E5%A4%A7%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">2.3.2	蓝牙模式大循环</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-3-3%E8%A1%A5%E5%85%85"><span class="toc-number">1.1.3.3.</span> <span class="toc-text">2.3.3	补充</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4%E6%B6%88%E6%81%AF"><span class="toc-number">1.1.4.</span> <span class="toc-text">2.4	消息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-1%E6%B6%88%E6%81%AF%E5%A4%84%E7%90%86%EF%BC%9A"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">2.4.1	消息处理：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-2%E6%B6%88%E6%81%AF%E6%9D%A5%E6%BA%90%EF%BC%9A"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">2.4.2	消息来源：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-3%E6%8C%89%E9%94%AE%E6%B6%88%E6%81%AF%E7%9A%84%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%EF%BC%9A"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">2.4.3	按键消息的注意事项：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-4%E5%BA%94%E7%94%A8%EF%BC%9A1S%E6%B6%88%E6%81%AF"><span class="toc-number">1.1.4.4.</span> <span class="toc-text">2.4.4	应用：1S消息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-4-5%E8%93%9D%E7%89%99%E6%B6%88%E6%81%AF%E5%87%BD%E6%95%B0%EF%BC%9A"><span class="toc-number">1.1.4.5.</span> <span class="toc-text">2.4.5	蓝牙消息函数：</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E6%B1%9B--AB5335%E7%B3%BB%E5%88%97%20%E8%93%9D%E7%89%99%E4%BF%A1%E5%8F%B7%E8%B6%85%E5%87%BA%E8%B7%9D%E7%A6%BB%E7%9A%84%E5%A4%84%E7%90%86/" title="中科蓝汛--AB5335系列蓝牙信号超出距离的处理"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/myblog/img/404.jpg'" alt="中科蓝汛--AB5335系列蓝牙信号超出距离的处理"/></a><div class="content"><a class="title" href="/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E6%B1%9B--AB5335%E7%B3%BB%E5%88%97%20%E8%93%9D%E7%89%99%E4%BF%A1%E5%8F%B7%E8%B6%85%E5%87%BA%E8%B7%9D%E7%A6%BB%E7%9A%84%E5%A4%84%E7%90%86/" title="中科蓝汛--AB5335系列蓝牙信号超出距离的处理">中科蓝汛--AB5335系列蓝牙信号超出距离的处理</a><time datetime="2022-07-18T16:20:37.708Z" title="发表于 2022-07-19 00:20:37">2022-07-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E8%AE%AF%E7%B3%BB%E5%88%97%E8%93%9D%E7%89%99IC%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85/" title="中科蓝讯系列蓝牙IC编译工具安装"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/myblog/img/404.jpg'" alt="中科蓝讯系列蓝牙IC编译工具安装"/></a><div class="content"><a class="title" href="/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E8%AE%AF%E7%B3%BB%E5%88%97%E8%93%9D%E7%89%99IC%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85/" title="中科蓝讯系列蓝牙IC编译工具安装">中科蓝讯系列蓝牙IC编译工具安装</a><time datetime="2022-07-18T16:20:37.705Z" title="发表于 2022-07-19 00:20:37">2022-07-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E8%AE%AF%E7%B3%BB%E5%88%97IC%E4%B8%8B%E8%BD%BD%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BB%8B%E7%BB%8D/" title="中科蓝讯系列IC下载工具安装及介绍"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/myblog/img/404.jpg'" alt="中科蓝讯系列IC下载工具安装及介绍"/></a><div class="content"><a class="title" href="/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E8%AE%AF%E7%B3%BB%E5%88%97IC%E4%B8%8B%E8%BD%BD%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85%E5%8F%8A%E4%BB%8B%E7%BB%8D/" title="中科蓝讯系列IC下载工具安装及介绍">中科蓝讯系列IC下载工具安装及介绍</a><time datetime="2022-07-18T16:20:37.701Z" title="发表于 2022-07-19 00:20:37">2022-07-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E8%AE%AF%E8%93%9D%E7%89%99%E6%96%B9%E6%A1%88%E5%BC%80%E5%8F%91%E8%A7%A3%E5%86%B3%E9%9F%B3%E7%AE%B1%E5%BC%80%E6%9C%BA%E5%99%97%E5%99%97%E5%A3%B0/" title="中科蓝讯--AB532X系列PWM的使用"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/myblog/img/404.jpg'" alt="中科蓝讯--AB532X系列PWM的使用"/></a><div class="content"><a class="title" href="/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E8%AE%AF%E8%93%9D%E7%89%99%E6%96%B9%E6%A1%88%E5%BC%80%E5%8F%91%E8%A7%A3%E5%86%B3%E9%9F%B3%E7%AE%B1%E5%BC%80%E6%9C%BA%E5%99%97%E5%99%97%E5%A3%B0/" title="中科蓝讯--AB532X系列PWM的使用">中科蓝讯--AB532X系列PWM的使用</a><time datetime="2022-07-18T16:20:37.698Z" title="发表于 2022-07-19 00:20:37">2022-07-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E6%B1%9B%E8%93%9D%E7%89%99%E8%80%B3%E6%9C%BAAB5356A_AB5376A%E8%BF%9B%E5%85%A5CBT%E6%A8%A1%E5%BC%8F/" title="中科蓝讯蓝牙耳机AB5356A_AB5376A进入CBT模式"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null;this.src='/myblog/img/404.jpg'" alt="中科蓝讯蓝牙耳机AB5356A_AB5376A进入CBT模式"/></a><div class="content"><a class="title" href="/myblog/2022/07/19/%E4%B8%AD%E7%A7%91%E8%93%9D%E6%B1%9B%E8%93%9D%E7%89%99%E8%80%B3%E6%9C%BAAB5356A_AB5376A%E8%BF%9B%E5%85%A5CBT%E6%A8%A1%E5%BC%8F/" title="中科蓝讯蓝牙耳机AB5356A_AB5376A进入CBT模式">中科蓝讯蓝牙耳机AB5356A_AB5376A进入CBT模式</a><time datetime="2022-07-18T16:20:37.695Z" title="发表于 2022-07-19 00:20:37">2022-07-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By JSmcu</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/myblog/js/utils.js"></script><script src="/myblog/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>